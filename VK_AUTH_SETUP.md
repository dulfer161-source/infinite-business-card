# üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ VK –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

## üìã –ß—Ç–æ —ç—Ç–æ –¥–∞—ë—Ç

VK OAuth –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –≤—Ö–æ–¥–∏—Ç—å –Ω–∞ —Å–∞–π—Ç —á–µ—Ä–µ–∑ VKontakte:
- ‚úÖ –ë—ã—Å—Ç—Ä–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ 1 –∫–ª–∏–∫
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –∏ email
- ‚úÖ –ù–µ –Ω—É–∂–Ω–æ –∑–∞–ø–æ–º–∏–Ω–∞—Ç—å –ø–∞—Ä–æ–ª–∏
- ‚úÖ –ù–∞–¥—ë–∂–Ω–∞—è –∑–∞—â–∏—Ç–∞ —á–µ—Ä–µ–∑ VK

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (5 –º–∏–Ω—É—Ç)

### –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å VK –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

1. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ https://dev.vk.com/
2. –ù–∞–∂–∞—Ç—å **"–°–æ–∑–¥–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"**
3. –ó–∞–ø–æ–ª–Ω–∏—Ç—å:
   - **–ù–∞–∑–≤–∞–Ω–∏–µ:** Infinite Business Card (–∏–ª–∏ –≤–∞—à–µ)
   - **–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:** –°–∞–π—Ç
   - **–ê–¥—Ä–µ—Å —Å–∞–π—Ç–∞:** `https://visitka.site`
   - **–ë–∞–∑–æ–≤—ã–π –¥–æ–º–µ–Ω:** `visitka.site`

4. –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å:
   - **ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è** (–Ω–∞–ø—Ä–∏–º–µ—Ä: 51234567)
   - **–ó–∞—â–∏—â—ë–Ω–Ω—ã–π –∫–ª—é—á** (–≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)

### –®–∞–≥ 2: –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã –≤ –ø—Ä–æ–µ–∫—Ç

–°–µ–∫—Ä–µ—Ç—ã —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã –≤ –ø—Ä–æ–µ–∫—Ç–µ, –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è:

1. –í —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ poehali.dev: **–ú–µ–Ω—é ‚Üí Secrets**
2. –ù–∞–π—Ç–∏ –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å:
   - `VK_APP_ID` = –≤–∞—à ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: `51234567`)
   - `VK_SECRET_KEY` = –≤–∞—à –∑–∞—â–∏—â—ë–Ω–Ω—ã–π –∫–ª—é—á (–Ω–∞–ø—Ä–∏–º–µ—Ä: `abc123XYZ...`)

### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Redirect URI –≤ VK

1. –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö VK –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚Üí **–ù–∞—Å—Ç—Ä–æ–π–∫–∏**
2. **Authorized redirect URIs** ‚Üí –¥–æ–±–∞–≤–∏—Ç—å:
   ```
   https://visitka.site/auth/vk
   ```
3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –®–∞–≥ 4: –î–µ–ø–ª–æ–π —Ñ—É–Ω–∫—Ü–∏–∏

Backend —Ñ—É–Ω–∫—Ü–∏—è —É–∂–µ –≥–æ—Ç–æ–≤–∞, –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –∑–∞–¥–µ–ø–ª–æ–∏—Ç—å:

```bash
# –§—É–Ω–∫—Ü–∏—è vk-auth –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∫–æ–º–º–∏—Ç–µ
```

–ò–ª–∏ –ø–æ–ø—Ä–æ—Å–∏—Ç—å –º–µ–Ω—è –∑–∞–¥–µ–ø–ª–æ–∏—Ç—å: "–Æ—Ä–∞, –∑–∞–¥–µ–ø–ª–æ–π vk-auth —Ñ—É–Ω–∫—Ü–∏—é"

---

## üéØ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ö–ª–∏–µ–Ω—Ç  ‚îÇ‚îÄ‚îÄ1‚îÄ‚îÄ‚îÄ‚îÇ  VK  ‚îÇ‚îÄ‚îÄ2‚îÄ‚îÄ‚îÄ‚îÇ vk-auth API ‚îÇ‚îÄ‚îÄ3‚îÄ‚îÄ‚îÄ‚îÇ Database ‚îÇ
‚îÇ (React) ‚îÇ      ‚îÇ OAuth‚îÇ      ‚îÇ  (Backend)  ‚îÇ      ‚îÇ (Users)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ                                  ‚îÇ                    ‚îÇ
     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ4‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îÇ
                (JWT Token)                                  ‚îÇ
     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ5‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  (User Data)
```

### –ü–æ—à–∞–≥–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å

1. **–ö–ª–∏–µ–Ω—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç auth URL:**
   ```javascript
   GET /vk-auth?redirect_uri=https://visitka.site/auth/vk
   
   Response:
   {
     "auth_url": "https://oauth.vk.com/authorize?client_id=..."
   }
   ```

2. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ auth_url:**
   - –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ VK
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–†–∞–∑—Ä–µ—à–∏—Ç—å"
   - VK —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ `https://visitka.site/auth/vk?code=ABC123...`

3. **–ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç code –Ω–∞ backend:**
   ```javascript
   POST /vk-auth
   Body: {
     "code": "ABC123...",
     "redirect_uri": "https://visitka.site/auth/vk"
   }
   ```

4. **Backend –æ–±–º–µ–Ω–∏–≤–∞–µ—Ç code –Ω–∞ access_token:**
   - –ó–∞–ø—Ä–æ—Å –∫ VK API: `https://oauth.vk.com/access_token`
   - –ü–æ–ª—É—á–∞–µ—Ç: `access_token`, `user_id`, `email`

5. **Backend –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
   - –ó–∞–ø—Ä–æ—Å –∫ VK API: `https://api.vk.com/method/users.get`
   - –ü–æ–ª—É—á–∞–µ—Ç: `first_name`, `last_name`, `photo_200`

6. **Backend —Å–æ–∑–¥–∞—ë—Ç/–Ω–∞—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î:**
   ```sql
   SELECT id, email FROM users WHERE vk_id = '12345678';
   -- –ï—Å–ª–∏ –Ω–µ—Ç, —Å–æ–∑–¥–∞—ë–º:
   INSERT INTO users (email, name, vk_id) VALUES (...);
   ```

7. **Backend –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç JWT —Ç–æ–∫–µ–Ω:**
   ```javascript
   jwt.encode({
     user_id: 42,
     email: "user@vk.com",
     exp: now + 30 days
   }, JWT_SECRET)
   ```

8. **Backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–∫–µ–Ω –∏ –¥–∞–Ω–Ω—ã–µ:**
   ```javascript
   Response:
   {
     "token": "eyJhbGciOiJIUzI1NiIs...",
     "user": {
       "id": 42,
       "email": "user@vk.com",
       "name": "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤"
     }
   }
   ```

9. **–ö–ª–∏–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–æ–∫–µ–Ω:**
   ```javascript
   localStorage.setItem('auth_token', token);
   // –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
   ```

---

## üíª Frontend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç VK Login

```typescript
// src/components/VKLogin.tsx
import { useState } from 'react';

export default function VKLogin() {
  const [loading, setLoading] = useState(false);

  const handleVKLogin = async () => {
    setLoading(true);
    
    try {
      // 1. –ü–æ–ª—É—á–∏—Ç—å auth URL
      const urlResponse = await fetch(
        'https://functions.poehali.dev/YOUR_VK_AUTH_FUNCTION_ID?redirect_uri=' + 
        encodeURIComponent(window.location.origin + '/auth/vk')
      );
      const { auth_url } = await urlResponse.json();
      
      // 2. –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ VK
      window.location.href = auth_url;
      
    } catch (error) {
      console.error('VK login failed:', error);
      setLoading(false);
    }
  };

  return (
    <button 
      onClick={handleVKLogin}
      disabled={loading}
      className="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600"
    >
      {loading ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : '–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ VK'}
    </button>
  );
}
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ callback

```typescript
// src/pages/VKCallback.tsx
import { useEffect, useState } from 'react';
import { useNavigate, useSearchParams } from 'react-router-dom';

export default function VKCallback() {
  const [searchParams] = useSearchParams();
  const navigate = useNavigate();
  const [error, setError] = useState('');

  useEffect(() => {
    const code = searchParams.get('code');
    
    if (!code) {
      setError('–ö–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –ø–æ–ª—É—á–µ–Ω');
      return;
    }

    const handleCallback = async () => {
      try {
        const response = await fetch(
          'https://functions.poehali.dev/YOUR_VK_AUTH_FUNCTION_ID',
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              code,
              redirect_uri: window.location.origin + '/auth/vk'
            })
          }
        );

        const data = await response.json();

        if (data.error) {
          setError(data.error);
          return;
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω
        localStorage.setItem('auth_token', data.token);
        localStorage.setItem('user', JSON.stringify(data.user));

        // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é
        navigate('/');

      } catch (err) {
        setError('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
      }
    };

    handleCallback();
  }, [searchParams, navigate]);

  if (error) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="bg-red-50 p-6 rounded-lg">
          <h2 className="text-red-600 font-bold mb-2">–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h2>
          <p>{error}</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen flex items-center justify-center">
      <div className="text-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
        <p className="text-gray-600">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ VK...</p>
      </div>
    </div>
  );
}
```

### –î–æ–±–∞–≤–∏—Ç—å —Ä–æ—É—Ç—ã

```typescript
// src/App.tsx
import { BrowserRouter, Routes, Route } from 'react-router-dom';
import VKCallback from './pages/VKCallback';

function App() {
  return (
    <BrowserRouter>
      <Routes>
        {/* –í–∞—à–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ä–æ—É—Ç—ã */}
        <Route path="/auth/vk" element={<VKCallback />} />
      </Routes>
    </BrowserRouter>
  );
}
```

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### ‚úÖ –ß—Ç–æ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ

1. **SSL/TLS:** –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ HTTPS
2. **CORS:** –ü—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
3. **JWT —Ç–æ–∫–µ–Ω—ã:** –° –∏—Å—Ç–µ—á–µ–Ω–∏–µ–º —á–µ—Ä–µ–∑ 30 –¥–Ω–µ–π
4. **Database:** Parameterized queries (–∑–∞—â–∏—Ç–∞ –æ—Ç SQL injection)
5. **–°–µ–∫—Ä–µ—Ç—ã:** –í environment variables (–Ω–µ –≤ –∫–æ–¥–µ)
6. **Error handling:** –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ —É—Ç–µ—á–∫–∏ –¥–∞–Ω–Ω—ã—Ö

### üõ°Ô∏è Best practices

1. **–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å:**
   - `access_token` –æ—Ç VK
   - `JWT_SECRET`
   - `VK_SECRET_KEY`

2. **–í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ backend:**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ code –ø–µ—Ä–µ–¥ –æ–±–º–µ–Ω–æ–º
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ redirect_uri
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç VK API

3. **Frontend –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
   - –¢–æ–∫–µ–Ω –≤ localStorage (–Ω–µ –≤ cookies –¥–ª—è SPA)
   - HTTPS-only –¥–ª—è production
   - –ù–µ —Ö—Ä–∞–Ω–∏—Ç—å sensitive data –≤ localStorage

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã VK auth

Security Monitor –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç VK –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤:

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ä—É—á–Ω—É—é:
curl https://functions.poehali.dev/YOUR_SECURITY_MONITOR_ID

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
{
  "checks": [
    {
      "name": "VK auth URL generation",
      "status": "passed",  # –¢–µ–ø–µ—Ä—å –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å passed –≤–º–µ—Å—Ç–æ warning
      "message": "VK OAuth configured correctly"
    }
  ]
}
```

### –õ–æ–≥–∏

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ VK auth —Ñ—É–Ω–∫—Ü–∏–∏:

```bash
# –í poehali.dev —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ:
Menu ‚Üí Logs ‚Üí Backend ‚Üí vk-auth

# –ò–ª–∏ —á–µ—Ä–µ–∑ API (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–æ—Å—Ç—É–ø)
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –ü–æ–ª—É—á–µ–Ω–∏–µ auth URL

```bash
curl "https://functions.poehali.dev/YOUR_VK_AUTH_FUNCTION_ID?redirect_uri=https://visitka.site/auth/vk"

# –û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:
{
  "auth_url": "https://oauth.vk.com/authorize?client_id=51234567&..."
}
```

### –¢–µ—Å—Ç 2: Callback –æ–±—Ä–∞–±–æ—Ç–∫–∞

1. –û—Ç–∫—Ä—ã—Ç—å auth_url –≤ –±—Ä–∞—É–∑–µ—Ä–µ
2. –ù–∞–∂–∞—Ç—å "–†–∞–∑—Ä–µ—à–∏—Ç—å"
3. VK –¥–æ–ª–∂–µ–Ω —Ä–µ–¥–∏—Ä–µ–∫—Ç–Ω—É—Ç—å –Ω–∞ `https://visitka.site/auth/vk?code=...`
4. Frontend –¥–æ–ª–∂–µ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç—å POST –∑–∞–ø—Ä–æ—Å —Å code
5. Backend –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å JWT —Ç–æ–∫–µ–Ω –∏ user –¥–∞–Ω–Ω—ã–µ

### –¢–µ—Å—Ç 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ë–î

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–ª—Å—è:

```sql
SELECT * FROM t_p18253922_infinite_business_ca.users 
WHERE vk_id IS NOT NULL 
ORDER BY created_at DESC 
LIMIT 5;
```

---

## üêõ Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: "VK credentials not configured"

**–ü—Ä–∏—á–∏–Ω–∞:** –°–µ–∫—Ä–µ—Ç—ã –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –∏–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ.

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã –≤ poehali.dev: Menu ‚Üí Secrets
2. `VK_APP_ID` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º (–±–µ–∑ –∫–∞–≤—ã—á–µ–∫): `51234567`
3. `VK_SECRET_KEY` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π: `abc123XYZ...`
4. –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤ –∑–∞–¥–µ–ø–ª–æ–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –∑–∞–Ω–æ–≤–æ

### –ü—Ä–æ–±–ª–µ–º–∞: "Authorization code required"

**–ü—Ä–∏—á–∏–Ω–∞:** Frontend –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `code` –≤ POST –∑–∞–ø—Ä–æ—Å–µ.

**–†–µ—à–µ–Ω–∏–µ:**
```javascript
// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ code –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è:
const code = new URLSearchParams(window.location.search).get('code');
console.log('VK code:', code); // –î–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π

// –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ backend:
fetch('/vk-auth', {
  method: 'POST',
  body: JSON.stringify({ code, redirect_uri: '...' })
});
```

### –ü—Ä–æ–±–ª–µ–º–∞: "Invalid redirect_uri"

**–ü—Ä–∏—á–∏–Ω–∞:** redirect_uri –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö.

**–†–µ—à–µ–Ω–∏–µ:** –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ redirect_uri –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π:
1. –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö VK –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: `https://visitka.site/auth/vk`
2. –í GET –∑–∞–ø—Ä–æ—Å–µ –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ auth_url: `?redirect_uri=https://visitka.site/auth/vk`
3. –í POST –∑–∞–ø—Ä–æ—Å–µ —Å code: `{"redirect_uri": "https://visitka.site/auth/vk"}`

### –ü—Ä–æ–±–ª–µ–º–∞: "Failed to get user info"

**–ü—Ä–∏—á–∏–Ω–∞:** VK API –Ω–µ –æ—Ç–¥–∞—ë—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤ VK –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –≤–∫–ª—é—á–µ–Ω—ã –Ω—É–∂–Ω—ã–µ scope:
   - Settings ‚Üí Permissions ‚Üí Email (–≤–∫–ª—é—á–∏—Ç—å)
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–µ—Ä—Å–∏—é VK API (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 5.131 –∏–ª–∏ –≤—ã—à–µ)
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ access_token –≤–∞–ª–∏–¥–Ω—ã–π

---

## üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ VK –ª–æ–≥–∏–Ω–æ–≤

–î–æ–±–∞–≤–∏—Ç—å –≤ analytics —Ñ—É–Ω–∫—Ü–∏—é:

```python
# backend/analytics/index.py

# –ü—Ä–∏ –ª–æ–≥–∏–Ω–µ —á–µ—Ä–µ–∑ VK:
cur.execute("""
    INSERT INTO analytics_events (event_type, user_id, data)
    VALUES ('vk_login', %s, %s)
""", (user_id, json.dumps({'source': 'vk', 'timestamp': datetime.now()})))
```

### –ú–µ—Ç—Ä–∏–∫–∏

```sql
-- –°–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ VK:
SELECT COUNT(*) FROM users WHERE vk_id IS NOT NULL;

-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ VK —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:
SELECT email, name, created_at 
FROM users 
WHERE vk_id IS NOT NULL 
ORDER BY created_at DESC 
LIMIT 10;

-- –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ VK vs Email —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π:
SELECT 
  CASE 
    WHEN vk_id IS NOT NULL THEN 'VK'
    ELSE 'Email'
  END as auth_type,
  COUNT(*) as count
FROM users
GROUP BY auth_type;
```

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ VK auth:

1. **–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∏–µ OAuth –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã:**
   - Google OAuth (–ø–æ—Ö–æ–∂–∞—è —Å—Ö–µ–º–∞)
   - Yandex OAuth
   - Mail.ru OAuth

2. **–£–ª—É—á—à–∏—Ç—å UX:**
   - –î–æ–±–∞–≤–∏—Ç—å –∏–∫–æ–Ω–∫—É VK –Ω–∞ –∫–Ω–æ–ø–∫—É
   - Loading —Å–æ—Å—Ç–æ—è–Ω–∏—è
   - Error messages –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

3. **–†–∞—Å—à–∏—Ä–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
   - –ü–æ–ª—É—á–∞—Ç—å —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è VK
   - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–∑–µ–π VK
   - –ü–æ—Å—Ç–∏–Ω–≥ –≤ VK –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è VK API:** https://dev.vk.com/ru/api/overview  
**VK OAuth –≥–∞–π–¥:** https://dev.vk.com/ru/api/access-token/implicit-flow-user  
**–°–æ–æ–±—â–µ—Å—Ç–≤–æ poehali.dev:** https://t.me/+QgiLIa1gFRY4Y2Iy  

---

*–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 2025-12-17*  
*Commit: 4d4bc49*  
*Status: ‚úÖ Ready for production*
